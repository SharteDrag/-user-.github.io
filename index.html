<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>団体戦もどき（自動リサイズ版）</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    h1 { margin: 20px 0; }

    #controls { margin: 10px 0; }

    #teams {
      display: flex;
      justify-content: center;
      gap: 20px;
      width: 100%;
    }

    .team {
      width: 45vw;
      height: 75vh;
      background: white;
      border: 1px solid #ccc;
      position: relative;
      overflow: hidden;
      padding: 10px;
    }

    .team-title {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 22px;
    }

    .player-list {
      font-size: 14px;
      margin-bottom: 10px;
      min-height: 20px;
    }

    .grid {
      position: relative;
      width: 100%;
      height: calc(100% - 80px);
    }

    .cell {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.2s;
    }

    .cell img {
      width: 100%;
      height: 100%;
    }

    .cell:hover {
      transform: scale(1.08);
    }

    .marked {
      border: 2px solid red;
      filter: brightness(50%);
    }

    #player-input-box {
      margin: 15px auto;
      padding: 10px;
      width: 70%;
      background: white;
      border: 1px solid #ccc;
    }

    .player-input {
      margin: 3px;
    }
  </style>
</head>
<body>

<h1>団体戦もどき（自動リサイズ版）</h1>

<div id="controls">
  <b>左チーム名：</b>
  <input type="text" id="leftName" value="左チーム">
  <b>スコア：</b>
  <input type="number" id="leftScore" value="0" min="0" style="width:60px">

  <br><br>

  <b>右チーム名：</b>
  <input type="text" id="rightName" value="右チーム">
  <b>スコア：</b>
  <input type="number" id="rightScore" value="0" min="0" style="width:60px">

  <br><br>

  左チーム画像数：<input type="number" id="leftCount" value="6" min="1" max="25">
  右チーム画像数：<input type="number" id="rightCount" value="6" min="1" max="25">

  <br><br>
  <button id="scoreBtn">スコア反映</button>
  <button id="drawBtn">画像抽選開始</button>
</div>

<div id="player-input-box">
  <div><b>プレイヤー（最大6名）</b></div>

  <input class="player-input" id="p1" placeholder="プレイヤー1">
  <input class="player-input" id="p2" placeholder="プレイヤー2">
  <input class="player-input" id="p3" placeholder="プレイヤー3"><br>
  <input class="player-input" id="p4" placeholder="プレイヤー4">
  <input class="player-input" id="p5" placeholder="プレイヤー5">
  <input class="player-input" id="p6" placeholder="プレイヤー6">

  <br><button id="assignBtn">チームに振り分け</button>
</div>

<div id="teams">
  <div class="team">
    <div class="team-title" id="leftTeamTitle">左チーム（0）</div>
    <div id="leftPlayers" class="player-list"></div>
    <div id="left-grid" class="grid"></div>
  </div>

  <div class="team">
    <div class="team-title" id="rightTeamTitle">右チーム（0）</div>
    <div id="rightPlayers" class="player-list"></div>
    <div id="right-grid" class="grid"></div>
  </div>
</div>

<script>
  let allImages = [];

  /* 画像読み込み（GitHub Pages 用） */
  fetch("images.json")
    .then(res => res.json())
    .then(images => { allImages = images; });

  /* -------- プレイヤー処理 -------- */
  document.getElementById("assignBtn").addEventListener("click", () => {
    const names = [];
    for (let i = 1; i <= 6; i++) {
      const v = document.getElementById("p" + i).value.trim();
      if (v) names.push(v);
    }

    const shuffledPlayers = [...names].sort(() => Math.random() - 0.5);
    const left = [], right = [];

    shuffledPlayers.forEach((name, i) => {
      (i % 2 === 0 ? left : right).push(name);
    });

    document.getElementById("leftPlayers").innerText = left.join(" / ");
    document.getElementById("rightPlayers").innerText = right.join(" / ");
  });

  /* -------- スコア更新 -------- */
  document.getElementById("scoreBtn").addEventListener("click", () => {
    document.getElementById("leftTeamTitle").innerText =
      `${leftName.value}（${leftScore.value}）`;
    document.getElementById("rightTeamTitle").innerText =
      `${rightName.value}（${rightScore.value}）`;
  });

  /* -------- 画像を正方形に自動リサイズ -------- */
  function loadAndResize(src, size = 256) {
    return new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.src = src;

      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext("2d");

        const minSide = Math.min(img.width, img.height);
        const sx = (img.width - minSide) / 2;
        const sy = (img.height - minSide) / 2;

        ctx.drawImage(img, sx, sy, minSide, minSide, 0, 0, size, size);
        resolve(canvas.toDataURL());
      };
    });
  }

  /* -------- グリッド作成 -------- */
  async function drawTeam(gridId, count, images) {
    const grid = document.getElementById(gridId);
    grid.innerHTML = "";

    const containerW = grid.clientWidth;
    const containerH = grid.clientHeight;

    const cols = Math.ceil(Math.sqrt(count));
    const rows = Math.ceil(count / cols);

    const cellSize = Math.min(containerW / cols, containerH / rows);

    for (let i = 0; i < images.length; i++) {
      const col = i % cols;
      const row = Math.floor(i / cols);

      const div = document.createElement("div");
      div.className = "cell";
      div.style.width = cellSize + "px";
      div.style.height = cellSize + "px";
      div.style.left = (col * cellSize) + "px";
      div.style.top = (row * cellSize) + "px";

      /* ▼ 自動リサイズした画像を追加 */
      const resized = await loadAndResize("images/" + images[i]);

      const image = document.createElement("img");
      image.src = resized;

      div.appendChild(image);
      div.onclick = () => div.classList.toggle("marked");

      grid.appendChild(div);
    }
  }

  /* -------- 抽選開始 -------- */
  document.getElementById("drawBtn").addEventListener("click", async () => {
    const leftCount = +leftCount.value;
    const rightCount = +rightCount.value;

    const shuffled = [...allImages].sort(() => Math.random() - 0.5);

    const leftImages = shuffled.slice(0, leftCount);
    const rightImages = shuffled.slice(leftCount, leftCount + rightCount);

    drawTeam("left-grid", leftCount, leftImages);
    drawTeam("right-grid", rightCount, rightImages);
  });
</script>

</body>
</html>

